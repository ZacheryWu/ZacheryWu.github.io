---
title: 浏览器的事件
date: 2020-04-02 19:17:13
tags:
---

 事件是将JavaScript和网页连接到一起的主要方式。为了能够使用交互完成交互，我们需要了解事件的传播(事件流)，以及事件的处理和使用方式。

## 事件流

在浏览器的发展过程中，IE和Netscape团队提出了完全相反的事件流概念，也就是我们常说的事件冒泡和事件捕获，后面w3c为了统一事件流，制定了统一的标准----先捕获再冒泡。

DOM事件模型分为三个阶段：事件捕获阶段，处于目标阶段、事件冒泡阶段。

1. 首先发生的是事件捕获，从document前往事件发生的元素，捕获前进，遇到注册的捕获的事件就会触发执行。(规范要求从document对象开始传播，然而大部分浏览器都是从window开始的)
2. 到达事件位置，触发事件（如果这里是最底层元素，并且这里既注册了捕获事件也注册了冒泡事件，那么谁先注册谁先执行）
3. 事件触发地点往document方向，冒泡前进，遇到注册的冒泡阶段就会立即执行。

配上一张w3c的说明图：

![Graphical representation of an event dispatched in a DOM tree using the DOM event flow](\images\eventflow.svg)

以下代码可以很好的说明上面的顺序：

```js
		const s1 = document.getElementById('s1');
		const s2 = document.getElementById('s2');
		const s3 = document.getElementById('s3');
		s1.addEventListener('click', () => {
			console.log('s1');
		}, true)
		s2.addEventListener('click', () => {
			console.log('s2 冒泡');
		}, false)
		s2.addEventListener('click', () => {
			console.log('s2 捕获');
		}, true)
		s3.addEventListener('click', () => {
			console.log('s3 冒泡')
		}, true)
		s3.addEventListener('click', () => {
			console.log('s3 捕获')
		}, true)
```

![1585834879294](\images\1585834879294.png)

(注意这里的s3是先触发的冒泡事件，因为s3上先注册冒泡事件，并且s3是最底层元素)

## 事件处理程序

有三种方法为一个DOM元素注册事件回调。

1. HTML事件处理程序

   ```html
   <button onclick="alert('Hello world!')">
   ```

   这样的注册方式有个缺点，那就是在html已经渲染，但是js未加载完成的时候，如果触发了事件，那么是找不到对应的回调函数的。而且会导致js和html代码高度耦合，这也是现在使用这种方式的人较少的原因。

2. DOM0级事件处理程序

   ```js
   myButton.onclick = function(event) {alert('hello!')}
   ```

   以这种方式添加的事件将会以事件冒泡的形式捕获，也可以通过同样的方法删除掉这个回调：

   ```js
   myButton.onclick = null
   ```

   这样的方式注册事件需要注意一点，那就是在这段js代码被解析之前，这个事件是不会被触发的。

3. DOM2级事件处理程序

   ```js
   myButton.addEventListener('click', greet, false);
   function greet(event) {
       alert('Hello world');
   } 
   ```

   addEventListener接受三个参数，触发方式、回调函数和捕获方式。如果第三个参数为false那么表示冒泡阶段触发，如果为true那么表示在捕获阶段触发。

   如果想要删除这个事件：

   ```js
   myButton.removeEventListener('click', greet);
   ```

   大多数情况下，我们采用冒泡阶段触发事件的方式来进行开发。

## 内存和性能

在JavaScript中，添加到页面上的事件处理程序数量将会直接关系到页面的整体运行性能。我们可以采用下面的方式来提高页面的性能：

### 事件代理

对于事件处理程序过多问题的解决方法就是事件代理。事件代理利用了事件冒泡，只对一个DOM指定事件处理程序，就可以管理某一类的事件。例如，click事件会一直冒泡到document层次，所以只要给document添加一个事件处理程序，而不需要给每一个div添加click事件处理程序。以下面的html代码为例：

```html
<ul id="list">
    <li id="list1">it's list1</li>
    <li id="list2">it's list2</li>
    <li id="list3">it's list3</li>
</ul>
```

如果一个个给li添加点击事件：

```js
const list1 = document.getElementById('list1');
const list2 = document.getElementById('list2');
const list3 = document.getElementById('list3');
list1.addEventListener('click', () => {
    console.log('click list1')
})
list2.addEventListener('click', () => {
    console.log('click list2')
})
list3.addEventListener('click', () => {
    console.log('click list3')
})
```

如果使用事件代理：

```js
const ul = document.getElementById('list');
ul.addEventListener('click', (event) => {
    switch(event.target.id) {
        case 'list1':
            console.log('click list1');
            break;
        case 'list2':
            console.log('click list2');
            break;
        case 'list3':
            console.log('click list3');
            break;
    }
})
```

在上面的代码里只为ul元素添加了一个click事件。由于事件冒泡，在这个事件处理程序里，我们可以通过检测id来采取适当的操作。达成的效果和一个个添加是一样的，但是这样占用的内存更小。

使用事件代理有以下好处：

1. document对象很快就可以访问，只要可点击的元素呈现在页面上，那么这个元素就立即具备了相应的功能。
2. 节省内存，能够提升整体性能。
3. 在页面中设置事件处理程序花的时间更少，因为只对一个DOM添加了事件处理程序。

比较适合使用事件代理的事件有：

- click
- mousedown
- mouseup
- keyup
- keydown
- keypress

而一些像mouseover、mouseout之类的则不合适。



### 移除事件处理程序

每当将事件处理程序指定给元素时，运行中的浏览器代码与支持页面交互的JavaScript代码之间就会建立一个连接。这种链接越多，页面执行也就越慢，因此我们需要在事件处理程序不再起作用时把它删掉。

有两种情况会造成，事件处理程序不被垃圾回收程序移除，将会永远的占据内存空间：

1. 从文档中移除带事件处理程序的元素时。如果通过innerHTML来删除元素，将会无法回收事件处理程序。
2. 卸载页面的时候，不过似乎IE8+的浏览器都会自动回收。



## 参考资料

JavaScript高级程序设计-第13章 事件

[DOM Event Architecture](https://www.w3.org/TR/DOM-Level-3-Events/#dom-event-architecture)

[事件及DOM](https://developer.mozilla.org/zh-CN/docs/Web/API/Document_Object_Model/Events)

[JavaScript事件机制](https://www.cnblogs.com/hustskyking/p/problem-javascript-event.html)

[最详细的JavaScript和事件解读](http://www.codeceo.com/article/javascript-event-anay.html)

[JavaScript 浏览器事件解读](https://zhuanlan.zhihu.com/p/23059366)