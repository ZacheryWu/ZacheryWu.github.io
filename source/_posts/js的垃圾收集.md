---
title: js的垃圾收集
date: 2020-04-01 21:24:21
tags:
---

 JavaScript具有自动垃圾收集机制，也就是说，执行环境会自动管理代码执行过程中使用的内存。

这种自动管理内存的方式其实很简单，就是每隔一段时间就找出没有再使用的内存，释放掉。而找出没有被使用的内存的方式一般有以下两种：

### 引用计数

引用计数是指跟踪记录每个值被使用的次数。当声明了一个变量，并且将一个引用类型的值赋给这个变量，那么这个值的引用次数就记为1。如果接下来又把这个值赋给了另一个变量，那么引用次数就会加一。与之相法，如果某个变量不再引用这个值，那么引用次数减一。如果一个值的引用次数变为0，那么这个值所占用的内存将在下一次垃圾回收中被回收掉。

听起来简单而又美好，然而这种方式存在一个很大的问题，那就是无法回收循环引用的值。举个例子：

```js
let obj1 = {
    a: obj2
}
let obj2 = {
    b: obj1
}
obj1 = null;
obj2 = null;
```

因为obj1中的属性a没有取消对obj2的引用，所以obj2的引用次数永远不会为0，也就永远不会被回收。

### 标记清除

标记清除把对象是否不再被使用简化为对象是否能够被获得。

JavaScript引擎将会定期的从根对象(全局对象)开始，找到所有被跟对象引用的对象，然后再去遍历这些对象，依次递归下去，将会找到所有可以获得的对象。然后就可以把内存中的对象分为可获得对象和不可获得对象。然后就可以进行垃圾回收了。

这个方法相比引用计数方法不会有循环引用的问题，因为没有被引用的对象是不可获得的，相反却不一定，被引用的对象也有可能是不可获得的。

### 总结

以上就是JavaScript中的垃圾回收的简单介绍。其实对于垃圾回收的算法实现更加复杂，标记清除和引用计数只是一种实现垃圾回收的思路。在V8中，为了使得垃圾回收更加的高效，堆使用的内存被分为新生代和老生代，引擎中的内存在新生代和老生代中转化，而且为了使得回收之后的空间不那么碎片化，还使用了标记整理的方式来对内存进行处理，在这里不再展开介绍。

### 参考资料

垃圾回收-JavaScript高级程序设计4.3

[内存管理](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Memory_Management)

[JavaScript内存泄漏教程-阮一峰](http://www.ruanyifeng.com/blog/2017/04/memory-leak.html)

[聊聊V8引擎的垃圾回收](https://juejin.im/post/5ad3f1156fb9a028b86e78be)

